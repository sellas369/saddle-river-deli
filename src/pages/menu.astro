---
import Menu from '../layouts/Menu.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Menuboard from '../components/Menuboard.svelte';
import { getEntry } from 'astro:content';
import Submenu from '../components/Submenu.svelte';

const menu = await getEntry('pages', 'menu');

type MenuboardSchema = CollectionEntry<'menuboard'>['data'];
type MenuSchema = CollectionEntry<'menu'>['data'];

interface Menuboard extends MenuboardSchema {
  board: Array<
    MenuSchema & {
      double: boolean;
    }
  >;
}

const menus = await getCollection('menu');

const menuboards = (await getCollection('menuboard'))
  .sort((a, b) => a.data.title.localeCompare(b.data.title))
  .sort((a, b) => {
    if (a.data.weight < b.data.weight) return -1;
    if (a.data.weight > b.data.weight) return 1;
    return 0;
  });

const menuCollection = menuboards.map((m) => {
  const content: Menuboard = m.data;
  content.slug = m.slug;

  content.board = m.data.board
    .map((b) => menus.find((i) => i.slug === b.id))
    .map((b) => {
      const data = b.data;
      data.slug = b.slug;
      const hasRegular = data.items.find((i) => i.regular !== null);
      const hasLarge = data.items.find((i) => i.large !== null);
      data.double = hasRegular !== undefined && hasLarge !== undefined;

      return data;
    });

  return content;
});

const submenu = menuCollection
  .map((m) => {
    return m.board.map((z) => ({
      title: z.title,
      slug: z.slug,
    }));
  })
  .flat();

const config = await getEntry('config', 'config');
---

<Menu title={menu?.data.title} slug={menu.slug}>
  <div slot="preamble" set:html={menu?.rendered.html} />

  <Submenu
    menu={submenu}
    title={{
      title: menu?.data.title,
      slug: menu?.slug,
    }}
    submenu={config?.data.submenu}
    slot="menu"
    client:load
  />

  {menuCollection.map((m) => <Menuboard item={m} />)}
</Menu>

<style lang="scss">
  :global(section.container) :global(:target) {
    scroll-margin-block-start: 4.5rem;

    @media (min-width: 800px) {
      scroll-margin-block-start: 1rem;
    }
  }
</style>
